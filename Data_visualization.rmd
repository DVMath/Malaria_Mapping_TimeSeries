---
title: "Visualization for SIVEP variables"
author: "Raquel Lana and Narimane"
date: "6 de dezembro de 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Aggregating SIVEP data for year to build API maps

- Packages
```{r}
library(foreign)
library('stringr')
library(tidyverse)
library(ggplot2)
library("scales")#para usar nas escalas gráficas- ver depois.
library("data.table")

```

### Loading SIVEP RData
Environment: NN or RL - RL is **F**.
```{r}
envNN = F

if(envNN){
  load("/SIVEP_clean.RData")
}else{load("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/SIVEP_clean.RData")
}

```


## Adding AGE RANGE

### Creating the continuos age by year and after by categories (age range) from IBGE
- Continuos age in year: here I dropped registries with inconsistency.
```{r}
df <- df %>% 
  filter(ID_PACIE < 30 & ID_DIMEA == "D" | ID_PACIE < 12 & ID_DIMEA == "M" | ID_PACIE <= 100 & ID_DIMEA == "A")

df$ID_PACIE <- as.double(df$ID_PACIE) 

df <- df %>% 
          mutate(AGE_CONT = if_else(ID_DIMEA == "A", ID_PACIE, 0))
```

- Age range
```{r}
df$AGE_RANGE <- NA 
df[which(df$AGE_CONT <= 4),]$AGE_RANGE <- "0-4"
df[which(df$AGE_CONT >= 5 & df$AGE_CONT <= 9),]$AGE_RANGE <- "5-9"
df[which(df$AGE_CONT >= 10 & df$AGE_CONT <= 14),]$AGE_RANGE <- "10-14"
df[which(df$AGE_CONT >= 15 & df$AGE_CONT <= 19),]$AGE_RANGE <- "15-19"
df[which(df$AGE_CONT >= 20 & df$AGE_CONT <= 24),]$AGE_RANGE <- "20-24"
df[which(df$AGE_CONT >= 25 & df$AGE_CONT <= 29),]$AGE_RANGE <- "25-29"
df[which(df$AGE_CONT >= 30 & df$AGE_CONT <= 34),]$AGE_RANGE <- "30-34"
df[which(df$AGE_CONT >= 35 & df$AGE_CONT <= 39),]$AGE_RANGE <- "35-39"
df[which(df$AGE_CONT >= 40 & df$AGE_CONT <= 44),]$AGE_RANGE <- "40-44"
df[which(df$AGE_CONT >= 45 & df$AGE_CONT <= 49),]$AGE_RANGE <- "45-49"
df[which(df$AGE_CONT >= 50 & df$AGE_CONT <= 54),]$AGE_RANGE <- "50-54"
df[which(df$AGE_CONT >= 55 & df$AGE_CONT <= 59),]$AGE_RANGE <- "55-59"
df[which(df$AGE_CONT >= 60 & df$AGE_CONT <= 64),]$AGE_RANGE <- "60-64"
df[which(df$AGE_CONT >= 65 & df$AGE_CONT <= 69),]$AGE_RANGE <- "65-69"
df[which(df$AGE_CONT >= 70 & df$AGE_CONT <= 74),]$AGE_RANGE <- "70-74"
df[which(df$AGE_CONT >= 75 & df$AGE_CONT <= 79),]$AGE_RANGE <- "75-79"
df[which(df$AGE_CONT >= 80),]$AGE_RANGE <- "80+"

df$AGE_RANGE = factor(df$AGE_RANGE, label=c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+"), levels= c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+"))

```

- See categories and descriptive statistics.
```{r}
summary(df)

```


- Malaria type and TIPO_LAM per year.
```{r}
LAM_M_type <- df %>%
              mutate(RES_EXAM = factor(RES_EXAM, c("V", "F", "F+V"), c("Vivax", "Falciparum", "V+F")),
                     TIPO_LAM = factor(TIPO_LAM, c("PCD", "ACD", "CV"), c("PCD", "ACD", "CV"))) %>%
              group_by(ANO, TIPO_LAM) %>%
              count(RES_EXAM)  
              
options(scipen = 10000)


dev.copy(png, "/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Plots_results/MalariaType_DetectionType", width = 800, height = 900, units = "px", pointsize = 12, res = 100)
    
TL <- ggplot(aes(y = n, x = ANO, color = TIPO_LAM), data = LAM_M_type) +
            geom_line(stat = "identity") +
            facet_grid(RES_EXAM ~ .) +
            scale_x_continuous(labels = seq(2003, 2018, 1), breaks = seq(2003, 2018, 1)) +
            labs(x = "Year", y = "Malaria cases", color = "Detection type") 

dev.off()

```


- ID_LVC_ and TIPO_LAM
From paper **WIEFELS et al. 2016**. Accuracy of the malaria epidemiological surveillance system data in the state of Amazonas. Acta Amazonica:
"The follow-up consultation was related to the active/ passive notification. The patient’s follow-up consultation occurs weeks after the confirmation of the malaria infection (World Health Organization 2012). It is a second consultation to certify the healing and is registered as a new notification, which is why it is essential to distinguish it from the first consultation to avoid duplicates. Two variables - the detection type, called TIPO_LAM (1-Passive, 2-Active and 3- Follow-up consultation) and the follow-up consultation, called ID_LVC (1-Yes, 2-No) certify the follow-up consultation. There were 201 inconsistent notifications checked as a follow- up consultation notification (TIPO_LAM=3) but also as its opposite (ID_LVC=2)."
```{r}
LAM_ID_type <- df %>%
              mutate(TIPO_LAM = factor(TIPO_LAM, c("PCD", "ACD", "CV"), c("PCD", "ACD", "CV"))) %>%
              group_by(ANO, TIPO_LAM) %>%
              count(ID_LVC_)  
              

options(scipen = 10000)

dev.copy(png, "/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Plots_results/DetectionType_LVC", width = 800, height = 900, units = "px", pointsize = 12, res = 100)

TLI <- ggplot(aes(y = n, x = ANO, color = TIPO_LAM), data = LAM_ID_type) +
            geom_line(stat = "identity") +
            facet_grid(ID_LVC_ ~ .) +
            scale_x_continuous(labels = seq(2003,2018,1), breaks = seq(2003,2018,1)) +
            labs(x = "Year", y = "Malaria cases stratified by cure verification", color = "Detection type")
        
dev.off()

```

- Malaria type and age
```{r}
M_age_gender <- df %>%
                  mutate(TIPO_LAM = factor(TIPO_LAM, c("PCD", "ACD", "CV"), c("PCD", "ACD", "CV")),
                         RES_EXAM = factor(RES_EXAM, c("V", "F", "F+V"), c("Vivax", "Falciparum", "V+F"))) %>%
                  group_by(ANO, RES_EXAM) %>%
                  count(AGE_RANGE, SEXO)

options(scipen = 10000)

dev.copy(png, "/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Plots_results/AgeCategories_MalariaType", width = 1100, height = 1000, units = "px", pointsize = 12, res = 100)

MA <- ggplot(aes(y = n, x = AGE_RANGE, fill = RES_EXAM), data = M_age_gender[which(M_age_gender$SEXO == "F" | M_age_gender$SEXO == "M"),]) +
            geom_bar(stat = "identity", position = "dodge") +
            facet_wrap(~ANO) +
            labs(x = "Age Categories", y = "Malaria cases") +
            theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
            guides(fill = guide_legend(title= "Malaria type")) 

dev.off()

```

- GENDER
```{r}
dev.copy(png, "/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Plots_results/Gender_MalariaType", width = 1100, height = 1000, units = "px", pointsize = 12, res = 100)

MG <- ggplot(aes(y = n, x = SEXO, fill = RES_EXAM), data = M_age_gender[which(M_age_gender$SEXO == "F" | M_age_gender$SEXO == "M"),]) +
            geom_bar(stat = "identity", position = "dodge") +
            facet_wrap(~ANO) +
            labs(x = "Gender", y = "Malaria cases") +
            scale_x_discrete(breaks = c("F", "M"), labels = c("Female", "Male")) +
            guides(fill = guide_legend(title = "Malaria type")) 

dev.off()

```

- To do age and gender stratified by type. Here I summed V+F with F and V. 
```{r}
df1 <- df %>%
        select(RES_EXAM, TIPO_LAM, SEXO, SINTOMAS, ID_LVC_, ANO, AGE_RANGE) %>%
        group_by(ANO, TIPO_LAM, SEXO, SINTOMAS, ID_LVC_, AGE_RANGE) %>%
        count(RES_EXAM) %>%
        spread(RES_EXAM, n, fill = 0) %>%
        rename(FALCI = "F") %>%
        rename(FV = "F+V") %>%
        rename(VIVAX = "V") %>%
        mutate(Falciparum = FALCI + FV) %>%
        mutate(Vivax = VIVAX + FV) %>%
        select(ANO, TIPO_LAM, SEXO, SINTOMAS, ID_LVC_, AGE_RANGE, Falciparum, Vivax) %>%
        gather(key = 'MALARIA_TYPE', value = 'CASES', -c(ANO, TIPO_LAM, SEXO, SINTOMAS, ID_LVC_, AGE_RANGE))

```


- AGE and GENDER stratified by malaria type
```{r}
#Change the title when change the type
dev.copy(png, "/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Plots_results/AgeCategory_Gender_Falciparum", width = 1100, height = 1000, units = "px", pointsize = 12, res = 100)

#Change the type
#df2 <- df1 %>% filter(MALARIA_TYPE == "Falciparum")

AG <- ggplot(aes(y = CASES, x = AGE_RANGE, fill = SEXO), data = df2[which(df2$SEXO == "F" | df2$SEXO == "M"),]) +
            geom_bar(stat = "identity", position = "dodge") +
            facet_wrap(~ANO) +
            labs(x = "Age categories", y = "Malaria falciparum cases") + #Change to vivax
            theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
            guides(fill = guide_legend(title = "Gender")) 

dev.off()

```


- SINTOMAS- ver com LVC e com TIPO_LAM
```{r}
Sint <- df1 %>%
          mutate(TIPO_LAM1 = factor(TIPO_LAM, c("PCD", "ACD", "CV"), c("PCD", "ACD", "CV")),
                 SINTOMAS1 = factor(SINTOMAS, c("YES", "NO"), c("YES", "NO")),
                 ID_LVC_1 = factor(ID_LVC_, c("YES", "NO"), c("YES", "NO")))

#Change the title when change the type
dev.copy(png, "/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Plots_results/Symptoms_DetectionType_Vivax", width = 1100, height = 1000, units = "px", pointsize = 12, res = 100)

# SCD <- ggplot(aes(y = CASES, x = SINTOMAS1, fill = ID_LVC_1), data = Sint[Sint$MALARIA_TYPE == "Vivax",]) +
#             geom_bar(stat = "identity", position = "dodge") +
#             facet_wrap(~ANO) +
#             labs(x = "Symptoms", y = "Malaria vivax cases") +
#             theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
#             guides(fill = guide_legend(title ="Cure Verification"))
# dev.off()

SCD2 <- ggplot(aes(y = CASES, x = SINTOMAS1, fill = TIPO_LAM1), data = Sint[Sint$MALARIA_TYPE == "Vivax",]) +
            geom_bar(stat = "identity", position = "dodge") +
            facet_wrap(~ANO) +
            labs(x = "Symptoms", y = "Malaria vivax cases") +
            theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
            guides(fill = guide_legend(title ="Detection type"))
dev.off()

# SCD3 <- ggplot(aes(y = CASES, x = TIPO_LAM1, fill = SINTOMAS1), data = Sint[Sint$MALARIA_TYPE == "Falciparum",]) +
#             geom_bar(stat = "identity", position = "dodge") +
#             facet_wrap(~ID_LVC_1) +
#             labs(x = "Detection type stratified by Cure verification", y = "Malaria falciparum cases") +
#             guides(fill = guide_legend(title ="Symptoms"))
# 
# dev.off()
            
```

Pregnant 
```{r}
unique(df$GESTANTE_1)
preg <- df %>%
          group_by(ANO, RES_EXAM, SEXO) %>%
          count(GESTANTE_)

pms <- ggplot(aes(y = n, x = GESTANTE_), data = preg) +
            geom_bar(stat = "identity", position = "dodge") +
            facet_wrap(~ANO) 
         
  
```




- Case per age and gender population size
- fazer essa tabela ficar no ponto para o merge com a tabela de casos por faixa etaria e sexo do sivep que eu fiz no scrpit Manipulate_data_maps_ts. Antes do merge, fazer um rbind dessa tabela do SIVEP considerando. BR, UF e MU também. Fazer o mesmo para essa.
```{r}
if(envNN){
  pop_strat <- read.csv("/BRA_AGE_SEX_MUNICIP_2010.csv")
}else{pop_strat <- fread("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Malaria_Mapping_TimeSeries_Data/BRA_AGE_SEX_MUNICIP_2010.csv", stringsAsFactors = F, encoding = 'Latin-1')
}

head(pop_strat)

#Filtrar o group 0 ano, mudar as categorias da variável group para deixar igual do SIVEP, mudar o nome da variaǘel tb. Cortar BR, UF e deixar só município. E ver se o código de município bate com do SIVEP.

pop_strat1 <- pop_strat %>%
                  filter(Group != "0 ano") %>%
                  filter(Level == "MU") %>%
                  mutate(Group = factor(Group, label=c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+"), levels= c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+")))


teste <- pop_strat %>%
              filter(Level == "BR" & Group == "5 anos" | Group == "6 anos" | Group == "7 anos" | Group == "8 anos" | Group == "9 anos" | Group == "5 a 9 anos")
     

# BR
# 2933764 + 2891614 + 2958801 + 2985271 + 3198318 = 14967768
# BR total
# 14967767
# 
# testesub <- pop_strat %>% filter(pop_strat$Code == "2304202") %>% filter(Group == "5 anos" | Group == "6 anos" | Group == "7 anos" | Group == "8 anos" | Group == "9 anos")
# 139444
# 
# pop_strat %>% filter(pop_strat$Code == "2304202") %>% filter(Group == "5 a 9 anos") #139443
# 
# testesub <- pop_strat %>% filter(pop_strat$Code == "12") %>% filter(Group == "5 anos" | Group == "6 anos" | Group == "7 anos" | Group == "8 anos" | Group == "9 anos")
# 82159
# 
# pop_strat %>% filter(pop_strat$Code == "12") %>% filter(Group == "5 a 9 anos") #82158
# 
# 
# 2304202

```


```{r}

```



- abrir o shape de assentamentos e ver se tem de grandes empreendimentos e suas infos.
