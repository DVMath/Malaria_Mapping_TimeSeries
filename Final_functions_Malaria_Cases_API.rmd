---
title: "Malaria_Cases_API_final_functions"
author: "Raquel Lana and Narimane Nekkab"
date: "4 de fevereiro de 2019"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Final functions for the analyzes and figures of the first paper

- Packages - change after for the header file together the parameters.
```{r}
library(foreign)
library('stringr')
library(tidyverse)
library('data.table')
library('forcats')
library(lubridate)
require(maptools, quietly = TRUE, warn.conflicts = FALSE)
library('maptools')
library(rgdal)

```

- organizar em função o que já fiz até agora pra calculo de API total e estratif por sexo e idade.
- ter uma função que organiza o banco do sivep deixando e tenha como rresultado final casos e api em um return().
- ter uma função para o cálculo de API total e outra estrat.

- depois disso pronto, ter um arquivo que chama a funções e plota os graficos etc.

- resolução e cortes:
2004-2018
poder escolher notificação, residencia e infecção
PCD + ACD
weekly
- uma tabela
notificação por UF e Mun
- segunda tabela
agge and gender



- mover para o header file
```{r}
# Get SIVEP data cleaned up and by species
FilePath = "/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/SIVEP_clean.RData"
StartYear = 2010
EndYear = 2011
AgTimeUnit = "week"
byNotification = F
byResidence = F
byInfection = T
d <- getWEEKLY_SIVEP_MALARIA_TYPE(FilePath, StartYear, EndYear, AgTimeUnit)

```

### Function
```{r}
getWEEKLY_SIVEP_MALARIA_TYPE <- function(FilePath, StartYear, EndYear, AgTimeUnit){
  
  # Get SIVEP raw notification data
  load(FilePath)
  #load("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/SIVEP_clean.RData")

  # Choose time period
  df <- df[which(df[,"DT_NOTIF"] >= paste0(StartYear,"-01-01") & df[,"DT_NOTIF"] <= paste0(EndYear, "-12-31")),]
  
  
  # Replace missing state code with municipality state code
  df$UF_NOTIF=substr(df$MUN_NOTI, 1, 2) 
  df$UF_RESID=substr(df$MUN_RESI, 1, 2)
  df$UF_INFEC=substr(df$MUN_INFE, 1, 2)

  # Select administrative level via code
  if(byNotification){
    df$PAIS_CODE <- 1
    names(df)[names(df) == 'UF_NOTIF'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_NOTI'] <- 'MUN_CODE'
  }
  if(byResidence){
    names(df)[names(df) == 'PAIS_RES'] <- 'PAIS_CODE'
    names(df)[names(df) == 'UF_RESID'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_RESI'] <- 'MUN_CODE'
  }
  if(byInfection){
    names(df)[names(df) == 'PAIS_INF'] <- 'PAIS_CODE'
    names(df)[names(df) == 'UF_INFEC'] <- 'UF_CODE'
    names(df)[names(df) == 'MUN_INFE'] <- 'MUN_CODE'
  }
  
  # Split data by malaria type and aggregate to day (MU - level)
  week_malaria_type_muni <- df %>%
    group_by(DT_NOTIF, MUN_CODE) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "MU") %>%
    select(DT_NOTIF, LEVEL, MUN_CODE, RES_EXAM, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(CODE = MUN_CODE,
           FALCI = "Falciparum",
           VF = "V+F",
           VIVAX = "Vivax") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%
    ungroup %>%
    select(-DT_NOTIF) %>%
    select(DATE, LEVEL, CODE, Falciparum, Vivax) %>%
    gather(key = 'TYPE', value = 'CASES', -c(DATE, LEVEL, CODE))

  
  # UF - level
  week_malaria_type_state <- df %>%
    group_by(DT_NOTIF, UF_CODE) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "UF") %>%
    select(DT_NOTIF, LEVEL, UF_CODE, RES_EXAM, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(CODE = UF_CODE,
           FALCI = "Falciparum",
           VF = "V+F",
           VIVAX = "Vivax") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%      
    ungroup %>%
    select(-DT_NOTIF) %>%
    select(DATE, LEVEL, CODE, Falciparum, Vivax) %>%
    gather(key = 'TYPE', value = 'CASES', -c(DATE, LEVEL, CODE))
  
  # BR - level
  week_malaria_type_brazil <- df %>%
    group_by(DT_NOTIF, PAIS_CODE) %>%
    count(RES_EXAM) %>%
    mutate(LEVEL = "BR")  %>% 
    select(DT_NOTIF, LEVEL, PAIS_CODE, RES_EXAM, n) %>%
    spread(RES_EXAM, n, fill = 0) %>%
    rename(CODE = PAIS_CODE,
           FALCI = "Falciparum",
           VF = "V+F",
           VIVAX = "Vivax") %>%
    mutate(Falciparum = FALCI + VF,
           Vivax = VIVAX + VF,
           DATE = floor_date(as.Date(DT_NOTIF, format = "%Y-%m-%d"), unit = AgTimeUnit)
           ) %>%
    ungroup %>%
    select(-DT_NOTIF) %>%
    select(DATE, LEVEL, CODE, Falciparum, Vivax) %>%
    gather(key = 'TYPE', value = 'CASES', -c(DATE, LEVEL, CODE))
    
  # Merge together
  SIVEP_MALARIA_TYPE <- rbind(week_malaria_type_brazil, week_malaria_type_state, week_malaria_type_muni)
  rm(df, treat, week_malaria_type_brazil, week_malaria_type_state, week_malaria_type_muni)


  return(SIVEP_MALARIA_TYPE)
  
}



```


```{r}

```

## Including Plots


```{r}


```

