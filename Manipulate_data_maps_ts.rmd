---
title: "Manipulate_data_maps_ts"
author: "Raquel Lana and Narimane"
date: "6 de dezembro de 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Aggregating SIVEP data for year to build API maps

- Packages
```{r}
library(foreign)
library('stringr')
library(tidyverse)
library(data.table)

```

### Loading SIVEP RData
Environment: NN or RL - RL is **F**.
```{r}
envNN = F

if(envNN){
  load("/SIVEP_clean.RData")
}else{load("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/SIVEP_clean.RData")
}

```

## Counting malaria type per date of notification, levels of administrate units (Country, State and Municipality).

### Counting malaria cases by day, UF, municipality and malaria type.
```{r}
day_malaria_type <- df %>%
                      group_by(DT_NOTIF, MUN_NOTI) %>%
                      count(RES_EXAM) %>%
                      mutate(LEVEL = "MU") %>%
                      select(DT_NOTIF, LEVEL, MUN_NOTI, RES_EXAM, n) %>%
                      spread(RES_EXAM, n, fill = 0) %>%
                      rename(CODE = MUN_NOTI) %>%
                      rename(FALCI = "F") %>%
                      rename(FV = "F+V") %>%
                      rename(VIVAX = "V") %>%
                      mutate(Falciparum = FALCI + FV) %>%
                      mutate(Vivax = VIVAX + FV) %>%
                      select(DT_NOTIF, LEVEL, CODE, Falciparum, Vivax) %>%
                      gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE))


```

### Counting malaria cases by day, state and malaria type
```{r}
day_malaria_type_state <- df %>%
                          group_by(DT_NOTIF, UF_NOTIF) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE = UF_NOTIF) %>%
                          rename(FALCI = "F") %>%
                          rename(FV = "F+V") %>%
                          rename(VIVAX = "V") %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE))

```


### Counting malaria cases by day, country and malaria type
```{r}
day_malaria_type_brazil <- df %>%
                          group_by(DT_NOTIF) %>%
                          count(RES_EXAM)%>%
                          mutate(LEVEL = "BR",
                                 CODE = "1") %>%
                          select(DT_NOTIF, LEVEL, CODE, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(FALCI = "F") %>%
                          rename(FV = "F+V") %>%
                          rename(VIVAX = "V") %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE))

```

## Adding GENDER

### Counting malaria cases by day, municipality, GENDER, malaria type.
```{r}
day_malaria_type_gender <- df %>%
                            group_by(DT_NOTIF, MUN_NOTI, SEXO) %>%
                            count(RES_EXAM) %>%
                            mutate(LEVEL = "MU") %>%
                            select(DT_NOTIF, LEVEL, MUN_NOTI, RES_EXAM, SEXO, n) %>%
                            spread(RES_EXAM, n, fill = 0) %>%
                            rename(CODE = MUN_NOTI, FALCI = "F", FV = "F+V", VIVAX = "V", GENDER = SEXO) %>%
                            mutate(Falciparum = FALCI + FV) %>%
                            mutate(Vivax = VIVAX + FV) %>%
                            select(DT_NOTIF, LEVEL, CODE, GENDER, Falciparum, Vivax) %>%
                            gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, GENDER))


```

### Counting malaria cases by day, state, GENDER and malaria type
```{r}
day_malaria_type_state_gender <- df %>%
                          group_by(DT_NOTIF, UF_NOTIF, SEXO) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, RES_EXAM, SEXO, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE = UF_NOTIF, FALCI = "F", FV = "F+V", VIVAX = "V", GENDER = SEXO) %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE, GENDER, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, GENDER))

```


### Counting malaria cases by day, country, GENDER and malaria type
```{r}
day_malaria_type_brazil_gender <- df %>%
                          group_by(DT_NOTIF, SEXO) %>%
                          count(RES_EXAM)%>%
                          mutate(LEVEL = "BR",
                                 CODE = "1") %>%
                          select(DT_NOTIF, LEVEL, CODE, RES_EXAM, SEXO, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(FALCI = "F", FV = "F+V", VIVAX = "V", GENDER = SEXO) %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE, GENDER, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, GENDER))

```


## Adding AGE RANGE

### Creating the continuos age by year and after by categories (age range) from IBGE
- Continuos age in year: here I dropped registries with inconsistency.
```{r}
df <- df %>% 
  filter(ID_PACIE < 30 & ID_DIMEA == "D" | ID_PACIE < 12 & ID_DIMEA == "M" | ID_PACIE <= 100 & ID_DIMEA == "A")

df$ID_PACIE <- as.double(df$ID_PACIE) 

df <- df %>% 
          mutate(AGE_CONT = if_else(ID_DIMEA == "A", ID_PACIE, 0))
```

- Age range
```{r}
df$AGE_RANGE <- NA 
df[which(df$AGE_CONT <= 4),]$AGE_RANGE <- "0-4"
df[which(df$AGE_CONT >= 5 & df$AGE_CONT <= 9),]$AGE_RANGE <- "5-9"
df[which(df$AGE_CONT >= 10 & df$AGE_CONT <= 14),]$AGE_RANGE <- "10-14"
df[which(df$AGE_CONT >= 15 & df$AGE_CONT <= 19),]$AGE_RANGE <- "15-19"
df[which(df$AGE_CONT >= 20 & df$AGE_CONT <= 24),]$AGE_RANGE <- "20-24"
df[which(df$AGE_CONT >= 25 & df$AGE_CONT <= 29),]$AGE_RANGE <- "25-29"
df[which(df$AGE_CONT >= 30 & df$AGE_CONT <= 34),]$AGE_RANGE <- "30-34"
df[which(df$AGE_CONT >= 35 & df$AGE_CONT <= 39),]$AGE_RANGE <- "35-39"
df[which(df$AGE_CONT >= 40 & df$AGE_CONT <= 44),]$AGE_RANGE <- "40-44"
df[which(df$AGE_CONT >= 45 & df$AGE_CONT <= 49),]$AGE_RANGE <- "45-49"
df[which(df$AGE_CONT >= 50 & df$AGE_CONT <= 54),]$AGE_RANGE <- "50-54"
df[which(df$AGE_CONT >= 55 & df$AGE_CONT <= 59),]$AGE_RANGE <- "55-59"
df[which(df$AGE_CONT >= 60 & df$AGE_CONT <= 64),]$AGE_RANGE <- "60-64"
df[which(df$AGE_CONT >= 65 & df$AGE_CONT <= 69),]$AGE_RANGE <- "65-69"
df[which(df$AGE_CONT >= 70 & df$AGE_CONT <= 74),]$AGE_RANGE <- "70-74"
df[which(df$AGE_CONT >= 75 & df$AGE_CONT <= 79),]$AGE_RANGE <- "75-79"
df[which(df$AGE_CONT >= 80),]$AGE_RANGE <- "80+"

df$AGE_RANGE = factor(df$AGE_RANGE, label=c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+"), levels= c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+"))

```

### Counting malaria cases by day, UF, municipality, AGE RANGE, malaria type.
```{r}
day_malaria_type_age <- df %>%
                            group_by(DT_NOTIF, MUN_NOTI, AGE_RANGE) %>%
                            count(RES_EXAM) %>%
                            mutate(LEVEL = "MU") %>%
                            select(DT_NOTIF, LEVEL, MUN_NOTI, RES_EXAM, AGE_RANGE, n) %>%
                            spread(RES_EXAM, n, fill = 0) %>%
                            rename(CODE = MUN_NOTI, FALCI = "F", FV = "F+V", VIVAX = "V", AGE_CAT = AGE_RANGE) %>%
                            mutate(Falciparum = FALCI + FV) %>%
                            mutate(Vivax = VIVAX + FV) %>%
                            select(DT_NOTIF, LEVEL, CODE, AGE_CAT, Falciparum, Vivax) %>%
                            gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, AGE_CAT))


```

### Counting malaria cases by day, UF, AGE RANGE and malaria type
```{r}
day_malaria_type_state_age <- df %>%
                          group_by(DT_NOTIF, UF_NOTIF, AGE_RANGE) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, RES_EXAM, AGE_RANGE, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE = UF_NOTIF, FALCI = "F", FV = "F+V", VIVAX = "V", AGE_CAT = AGE_RANGE) %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE, AGE_CAT, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, AGE_CAT))

```


### Counting malaria cases by day, AGE RANGE and malaria type
```{r}
day_malaria_type_brazil_age <- df %>%
                          group_by(DT_NOTIF, AGE_RANGE) %>%
                          count(RES_EXAM)%>%
                          mutate(LEVEL = "BR",
                                 CODE = "1") %>%
                          select(DT_NOTIF, LEVEL, CODE, RES_EXAM, AGE_RANGE, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(FALCI = "F", FV = "F+V", VIVAX = "V", AGE_CAT = AGE_RANGE) %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE, AGE_CAT, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, AGE_CAT))

```

### Checking registers per notification, residence and probable infection place.
- UF_NOTIF: 9 
- UF_RESID: 27 + missings
- UF_INFEC: 27 + missings
```{r}
length(unique(df$UF_NOTIF))
length(unique(df$UF_RESID))
length(unique(df$UF_INFEC))

```

- Different visualizations per state. 
```{r}
NOTIF_RESID <- df %>% 
                group_by(UF_NOTIF, UF_RESID) %>%
                count(RES_EXAM)# %>%
#                filter(is.na(UF_RESID))


NOTIF_INFEC<- df %>% 
                group_by(UF_NOTIF, UF_INFEC) %>%
                count(RES_EXAM)# %>%
#                filter(is.na(UF_INFEC))

RESID_INFEC <- df %>% 
                group_by(UF_RESID, UF_INFEC) %>%
                count(RES_EXAM)# %>%
#                filter(is.na(UF_INFEC))
  
ALL_UF <- df %>% 
            group_by(UF_NOTIF, UF_RESID, UF_INFEC) %>%
            count(RES_EXAM)

```

## Malaria per notification, residence and probable infection places

### Counting malaria cases per day, notification, residence, probable infection per country and malaria type.
```{r}
day_malaria_type_places_country <- df %>%
                          group_by(DT_NOTIF, PAIS_RES, PAIS_INF) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "BR",
                                 PAIS_NOTI = "1") %>%
                          select(DT_NOTIF, LEVEL, PAIS_NOTI, PAIS_RES, PAIS_INF, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE_NOTIF = PAIS_NOTI, CODE_RESID = PAIS_RES, CODE_INFEC = PAIS_INF, FALCI = "F", FV = "F+V", VIVAX = "V") %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC))

```


### Counting malaria cases per day, notification, residence, probable infection per state and malaria type.
```{r}
day_malaria_type_places_state <- df %>%
                          group_by(DT_NOTIF, UF_NOTIF, UF_RESID, UF_INFEC) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, UF_RESID, UF_INFEC, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE_NOTIF = UF_NOTIF, CODE_RESID = UF_RESID, CODE_INFEC = UF_INFEC, FALCI = "F", FV = "F+V", VIVAX = "V") %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC))


```


### Counting malaria cases per day, notification, residence, probable infection per municipality and malaria type.
```{r}
day_malaria_type_places_muni <- df %>%
                          group_by(DT_NOTIF, MUN_NOTI, MUN_RESI, MUN_INFE) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "MU") %>%
                          select(DT_NOTIF, LEVEL, MUN_NOTI, MUN_RESI, MUN_INFE, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE_NOTIF = MUN_NOTI, CODE_RESID = MUN_RESI, CODE_INFEC = MUN_INFE, FALCI = "F", FV = "F+V", VIVAX = "V") %>%
                          mutate(Falciparum = FALCI + FV) %>%
                          mutate(Vivax = VIVAX + FV) %>%
                          select(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC))


```



