---
title: "Manipulate_data_maps_ts"
author: "Raquel Lana and Narimane"
date: "6 de dezembro de 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Aggregating SIVEP data for year to build API maps

- Packages
```{r}
library(foreign)
library('stringr')
library(tidyverse)
library('data.table')

```

### Loading SIVEP RData
Environment: NN or RL - RL is **F**.
```{r}
envNN = F

if(envNN){
  load("/SIVEP_clean.RData")
}else{load("/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Pasteur/SIVEP_clean.RData") #Fiocruz desktop
#}else{load("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/SIVEP_clean.RData") #my pc
  
}

```

## Counting malaria type per date of notification, levels of administrate units (Country, State and Municipality).

### Counting malaria cases by day, UF, municipality and malaria type.
```{r}
day_malaria_type <- df %>%
                      group_by(DT_NOTIF, MUN_NOTI) %>%
                      count(RES_EXAM) %>%
                      mutate(LEVEL = "MU") %>%
                      select(DT_NOTIF, LEVEL, MUN_NOTI, RES_EXAM, n) %>%
                      spread(RES_EXAM, n, fill = 0) %>%
                      rename(CODE = MUN_NOTI) %>%
                      rename(FALCI = "Falciparum") %>%
                      rename(VF = "V+F") %>%
                      rename(VIVAX = "Vivax") %>%
                      mutate(Falciparum = FALCI + VF) %>%
                      mutate(Vivax = VIVAX + VF) %>%
                      select(DT_NOTIF, LEVEL, CODE, Falciparum, Vivax) %>%
                      gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE))


```

### Counting malaria cases by day, state and malaria type
```{r}
day_malaria_type_state <- df %>%
                          group_by(DT_NOTIF, UF_NOTIF) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE = UF_NOTIF) %>%
                          rename(FALCI = "Falciparum") %>%
                          rename(VF = "V+F") %>%
                          rename(VIVAX = "Vivax") %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE))

```


### Counting malaria cases by day, country and malaria type
```{r}
day_malaria_type_brazil <- df %>%
                          group_by(DT_NOTIF) %>%
                          count(RES_EXAM)%>%
                          mutate(LEVEL = "BR",
                                 CODE = "1") %>%
                          select(DT_NOTIF, LEVEL, CODE, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(FALCI = "Falciparum") %>%
                          rename(VF = "V+F") %>%
                          rename(VIVAX = "Vivax") %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE))

```

## Adding GENDER

### Counting malaria cases by day, municipality, GENDER, malaria type.
```{r}
day_malaria_type_gender <- df %>%
                            group_by(DT_NOTIF, MUN_NOTI, SEXO) %>%
                            count(RES_EXAM) %>%
                            mutate(LEVEL = "MU") %>%
                            select(DT_NOTIF, LEVEL, MUN_NOTI, RES_EXAM, SEXO, n) %>%
                            spread(RES_EXAM, n, fill = 0) %>%
                            rename(CODE = MUN_NOTI, FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax", GENDER = SEXO) %>%
                            mutate(Falciparum = FALCI + VF) %>%
                            mutate(Vivax = VIVAX + VF) %>%
                            select(DT_NOTIF, LEVEL, CODE, GENDER, Falciparum, Vivax) %>%
                            gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, GENDER))


```

### Counting malaria cases by day, state, GENDER and malaria type
```{r}
day_malaria_type_state_gender <- df %>%
                          group_by(DT_NOTIF, UF_NOTIF, SEXO) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, RES_EXAM, SEXO, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE = UF_NOTIF, FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax", GENDER = SEXO) %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE, GENDER, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, GENDER))

```


### Counting malaria cases by day, country, GENDER and malaria type
```{r}
day_malaria_type_brazil_gender <- df %>%
                          group_by(DT_NOTIF, SEXO) %>%
                          count(RES_EXAM)%>%
                          mutate(LEVEL = "BR",
                                 CODE = "1") %>%
                          select(DT_NOTIF, LEVEL, CODE, RES_EXAM, SEXO, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax", GENDER = SEXO) %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE, GENDER, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, GENDER))

```


### Counting malaria cases by day, UF, municipality, AGE Categories, malaria type.
```{r}
day_malaria_type_age <- df %>%
                            group_by(DT_NOTIF, MUN_NOTI, AGE_CAT) %>%
                            count(RES_EXAM) %>%
                            mutate(LEVEL = "MU") %>%
                            select(DT_NOTIF, LEVEL, MUN_NOTI, RES_EXAM, AGE_CAT, n) %>%
                            spread(RES_EXAM, n, fill = 0) %>%
                            rename(CODE = MUN_NOTI, FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax") %>%
                            mutate(Falciparum = FALCI + VF) %>%
                            mutate(Vivax = VIVAX + VF) %>%
                            select(DT_NOTIF, LEVEL, CODE, AGE_CAT, Falciparum, Vivax) %>%
                            gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, AGE_CAT))


```

### Counting malaria cases by day, UF, AGE RANGE and malaria type
```{r}
day_malaria_type_state_age <- df %>%
                          group_by(DT_NOTIF, UF_NOTIF, AGE_CAT) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, RES_EXAM, AGE_CAT, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE = UF_NOTIF, FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax") %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE, AGE_CAT, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, AGE_CAT))

```


### Counting malaria cases by day, AGE categories and malaria type
```{r}
day_malaria_type_brazil_age <- df %>%
                          group_by(DT_NOTIF, AGE_CAT) %>%
                          count(RES_EXAM)%>%
                          mutate(LEVEL = "BR",
                                 CODE = "1") %>%
                          select(DT_NOTIF, LEVEL, CODE, RES_EXAM, AGE_CAT, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax") %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE, AGE_CAT, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE, AGE_CAT))

```

### Checking registers per notification, residence and probable infection place.
- UF_NOTIF: 9 
- UF_RESID: 27 + missings
- UF_INFEC: 27 + missings
```{r}
length(unique(df$UF_NOTIF))
length(unique(df$UF_RESID))
length(unique(df$UF_INFEC))

```

- Different visualizations per state. 
```{r}
NOTIF_RESID <- df %>% 
                group_by(UF_NOTIF, UF_RESID) %>%
                count(RES_EXAM)# %>%
#                filter(is.na(UF_RESID))


NOTIF_INFEC<- df %>% 
                group_by(UF_NOTIF, UF_INFEC) %>%
                count(RES_EXAM)# %>%
#                filter(is.na(UF_INFEC))

RESID_INFEC <- df %>% 
                group_by(UF_RESID, UF_INFEC) %>%
                count(RES_EXAM)# %>%
#                filter(is.na(UF_INFEC))
  
ALL_UF <- df %>% 
            group_by(UF_NOTIF, UF_RESID, UF_INFEC) %>%
            count(RES_EXAM)

```

## Malaria per notification, residence and probable infection places

### Counting malaria cases per day, notification, residence, probable infection per country and malaria type.
```{r}
day_malaria_type_places_country <- df %>%
                          group_by(DT_NOTIF, PAIS_RES, PAIS_INF) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "BR",
                                 PAIS_NOTI = "1") %>%
                          select(DT_NOTIF, LEVEL, PAIS_NOTI, PAIS_RES, PAIS_INF, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE_NOTIF = PAIS_NOTI, CODE_RESID = PAIS_RES, CODE_INFEC = PAIS_INF, FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax") %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC))

```


### Counting malaria cases per day, notification, residence, probable infection per state and malaria type.
```{r}
day_malaria_type_places_state <- df %>%
                          group_by(DT_NOTIF, UFenvNN = F_NOTIF, UF_RESID, UF_INFEC) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "UF") %>%
                          select(DT_NOTIF, LEVEL, UF_NOTIF, UF_RESID, UF_INFEC, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE_NOTIF = UF_NOTIF, CODE_RESID = UF_RESID, CODE_INFEC = UF_INFEC, FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax") %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC))


```


### Counting malaria cases per day, notification, residence, probable infection per municipality and malaria type.
```{r}
day_malaria_type_places_muni <- df %>%
                          group_by(DT_NOTIF, MUN_NOTI, MUN_RESI, MUN_INFE) %>%
                          count(RES_EXAM) %>%
                          mutate(LEVEL = "MU") %>%
                          select(DT_NOTIF, LEVEL, MUN_NOTI, MUN_RESI, MUN_INFE, RES_EXAM, n) %>%
                          spread(RES_EXAM, n, fill = 0) %>%
                          rename(CODE_NOTIF = MUN_NOTI, CODE_RESID = MUN_RESI, CODE_INFEC = MUN_INFE, FALCI = "Falciparum", VF = "V+F", VIVAX = "Vivax") %>%
                          mutate(Falciparum = FALCI + VF) %>%
                          mutate(Vivax = VIVAX + VF) %>%
                          select(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC, Falciparum, Vivax) %>%
                          gather(key = 'TYPE', value = 'CASES', -c(DT_NOTIF, LEVEL, CODE_NOTIF, CODE_RESID, CODE_INFEC))


```


# Case per age and gender population size
- fazer essa tabela ficar no ponto para o merge com a tabela de casos por faixa etaria e sexo do sivep. Antes do merge, fazer um rbind dessa tabela do SIVEP considerando. BR, UF e MU também. Fazer o mesmo para essa.
```{r}
if(envNN){
  pop_strat <- read.csv("/BRA_AGE_SEX_MUNICIP_2010.csv")
}else{pop_strat <- fread("/home/claudia/Documentos/PosDoc_PROCC/malaria/AnalisesRaquel/Pasteur/Malaria_Mapping_TimeSeries_Data/BRA_AGE_SEX_MUNICIP_2010.csv", stringsAsFactors = F, encoding = 'Latin-1')}

#pop_strat <- fread("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/Malaria_Mapping_TimeSeries_Data/BRA_AGE_SEX_MUNICIP_2010.csv", stringsAsFactors = F, encoding = 'Latin-1') #my pc

head(pop_strat)
unique(pop_strat$Level) #"BR" "GR" "UF" "MU" --> cortar "GR"
unique(pop_strat$Code) # cortar o último dígito
unique(pop_strat$Group) # retirar "0 ano", "1 ano", "2 anos", 3 anos", "4 anos", "5 anos", "6 anos", "7 anos", "8 anos", "9 anos", "10 anos", "11 anos", "12 anos", "13 anos", "14 anos", "15 anos", "16 anos", "17 anos",  "18 anos", "19 anos", "20 anos", "21 anos", "22 anos", "23 anos", "24 anos". Virar tudo uma só a aprtir daqui: "80 anos ou mais", "80 a 84 anos", "85 a 89 anos", "90 a 94 anos", "95 a 99 anos", "100 anos ou mais".
summary(pop_strat)
#Tranformar Men e Women em números.

```

LEVEL| CODE | AGE_CAT == Group | Total | Male | Female


- Filtrar o group 0 ano, mudar as categorias da variável group para deixar igual do SIVEP, mudar o nome da variaǘel tb. E ver se o código de município bate com do SIVEP.
- recategorizar Group para "0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+"), levels= c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+".

- A categoria "80 anos ou mais" está como NA ára todos. Vou ter que gerar somando as categorias que são iguais ou maiores.
- Na categoria "100 anos ou mais", substituir em Total, Men e Women, os "-" que deveria na verdade ser NA.
```{r}
pop_strat1 <- pop_strat %>%
                  filter(Group == "0 a 4 anos" | Group == "5 a 9 anos" | Group == "10 a 14 anos" | Group == "15 a 19 anos" | Group == "20 a 24 anos" | Group == "25 a 29 anos" | Group == "30 a 34 anos" | Group == "35 a 39 anos" | Group == "40 a 44 anos" | Group == "45 a 49 anos"  | Group == "50 a 54 anos" | Group == "55 a 59 anos" | Group == "60 a 64 anos" | Group == "65 a 69 anos" | Group == "70 a 74 anos" | Group == "75 a 79 anos" | Group == "80 a 84 anos" | Group == "85 a 89 anos" | Group == "90 a 94 anos" | Group == "95 a 99 anos" | Group == "100 anos ou mais") %>%
                  mutate(Group = ifelse(Group == "80 anos ou mais" | Group == "80 a 84 anos" | Group == "85 a 89 anos" | Group == "90 a 94 anos" | Group == "95 a 99 anos" | Group == "100 anos ou mais", "80 anos ou mais", Group))

# Não sei fazer em Tidyverse, fiz no base.   
pop_strat1$Men <- as.integer(pop_strat1$Men)
pop_strat1$Women <- as.integer(pop_strat1$Women)
pop_strat1 <- aggregate(cbind(Total, Men, Women) ~ Level + Code + Name + Group, data = pop_strat1, FUN = sum)
  
  
#pop_strat1 <- pop_strat1 %>%
#                    mutate(Group = factor(Group, levels= c("0 a 4 anos", "10 a 14 anos", "15 a 19 anos", "20 a 24 anos", "25 a 29 anos", "30 a #34 anos",  "35 a 39 anos", "40 a 44 anos", "45 a 49 anos"    "5 a 9 anos"      "50 a 54 anos"    "55 a 59 anos"   
#[13] "60 a 64 anos"    "65 a 69 anos"    "70 a 74 anos"    "75 a 79 anos"    "80 anos ou mais"), #label=c("0-4","5-9","10-14","15-19","20-24","25-29","30-34","35-39","40-44","45-49","50-54","55-59","60-64","65-69","70-74","75-79","80+"))) #%>%
 #                   filter(Level == "GR") %>%
                 



     

# BR
# 2933764 + 2891614 + 2958801 + 2985271 + 3198318 = 14967768
# BR total
# 14967767
# 
# testesub <- pop_strat %>% filter(pop_strat$Code == "2304202") %>% filter(Group == "5 anos" | Group == "6 anos" | Group == "7 anos" | Group == "8 anos" | Group == "9 anos")
# 139444
# 
# pop_strat %>% filter(pop_strat$Code == "2304202") %>% filter(Group == "5 a 9 anos") #139443
# 
# testesub <- pop_strat %>% filter(pop_strat$Code == "12") %>% filter(Group == "5 anos" | Group == "6 anos" | Group == "7 anos" | Group == "8 anos" | Group == "9 anos")
# 82159
# 
# pop_strat %>% filter(pop_strat$Code == "12") %>% filter(Group == "5 a 9 anos") #82158
# 
# 
# 2304202

```

- abrir o shape de assentamentos e ver se tem de grandes empreendimentos e suas infos.
