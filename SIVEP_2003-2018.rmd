---
title: "SIVEP 2003-2018"
author: "Raquel Lana e Daniel Villela"
date: "April 04, 2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

# SIVEP-malária data  
Obs.: Previous verification and manipulation in other script.

### Libraries
```{r}
library(foreign)
library('stringr')
library("tidyverse")
library(lubridate)

```

### Loading SIVEP RData
Environment: NN or RL - RL is **F**.
```{r}
envNN = F

if(envNN){
  load("/RData_full.RData")
}else{load("/home/raquel/Documentos/PosDoc_PROCC/OwncloudPD/malaria/AnalisesRaquel/Pasteur/RData_full.RData")
}

df <- df %>% select(-DT_ENVLO, -DT_DIGIT, -COD_UNIN, -COD_AGEN, -HEMOPARASI, -EXAMINADOR) %>% filter(RES_EXAM != "0")

```

## Malaria type
### RES_EXAM
1 - Negativa  
2 - Falciparum  
3 - F+FG  
4 - Vivax  
5 - F+V  
6 - V+FG  only v 
7 - FG  
8 - Malariae  
9 - F+M  
10 – Ovale  
11 – Não F    

For tests done with ** rapid test **:  
1- Negative  
2- F (P. falciparum)  
5- F+V (P. falciparum + P. vivax)  
11- Não F (no falciparum)  

- Table of counts and frequency of occurrence by type of malaria per year.
```{r}
freq <- df %>%
    group_by(ANO) %>%
    count(RES_EXAM) %>%
    mutate(freq_mal = n / sum(n) * 100)

```

- Visualizations without customization  
```{r}
gf <- ggplot(aes(y = freq_mal, x = ANO, color = RES_EXAM), data = freq)
gf <- gf + geom_bar(stat = "identity") + facet_grid(RES_EXAM ~ .)
gf

gf <- ggplot(aes(y = freq_mal, x = ANO, group = RES_EXAM, color = RES_EXAM), data = freq)
gf <- gf + geom_bar(stat = "identity") 
gf

#Cases
gf <- ggplot(aes(y = n, x = ANO, color = RES_EXAM), data = freq)
gf <- gf + geom_line() + facet_grid(RES_EXAM ~ .)
gf

### Only vivax and falciparum
freq1 <- freq %>%
      filter(RES_EXAM == "2" | RES_EXAM == "4")

gf <- ggplot(aes(y = n, x = ANO, color = RES_EXAM), data = freq1)
gf <- gf + geom_line() + facet_grid(RES_EXAM ~ .)
gf

### Ohers types
freq2 <- freq %>%
      filter(RES_EXAM == "3" | RES_EXAM == "5" | RES_EXAM == "6" | RES_EXAM == "7" | RES_EXAM == "8" | RES_EXAM == "9" | RES_EXAM == "10" | RES_EXAM == "11")

gmal <- ggplot(aes(y = n, x = ANO, color = RES_EXAM), data = freq2)
gmal <- gmal + geom_line() + facet_grid(RES_EXAM ~ .)
gmal

```


### Tipo de malária, tipo de lamina, tipo de exame por ANO.
**TIPO_LAM**: 
1 – PCD  
2 – ACD  
3 – LVC 

**ID_LVC_**: 
1-  LVC.
2-  No LVC.

Problems with these variables- some incosistencies.

**EXAME**: Informa o tipo de exame realizado de acordo com a tabela abaixo.
1 = Gota espessa/Esfregaço
2 = Teste rápido


- TIPO_LAM and Year
```{r}
tl <- df %>%
    group_by(ANO) %>%
    count(TIPO_LAM) %>%
    mutate(f.lam = n / sum(n) * 100)

gt <- ggplot(aes(y = n, x = ANO, group = TIPO_LAM, color = TIPO_LAM), data = tl)
gt <- gt + geom_line()
gt 

gt <- ggplot(aes(y = f.lam, x = ANO, color = TIPO_LAM), data = tl)
gt <- gt + geom_bar(stat = "identity") + facet_grid(TIPO_LAM ~ .)
gt 
```

- Malaria type, TIPO_LAM and year
```{r}
v_tl <- df %>%
    group_by(ANO, TIPO_LAM) %>%
    count(RES_EXAM)

gv <- ggplot(aes(y = n, x = ANO, group = TIPO_LAM, color = TIPO_LAM), data = v_tl)
gv <- gv + geom_line() + facet_grid(RES_EXAM ~ .)
gv

gv <- ggplot(aes(y = n, x = ANO, group = RES_EXAM, color = RES_EXAM), data = v_tl)
gv <- gv + geom_line() + facet_grid(TIPO_LAM ~ .)
gv
```

- EXAME_, TIPO_LAM and year
```{r}
exam <- df %>%
    group_by(ANO, EXAME_) %>%
    count(TIPO_LAM)

ge <- ggplot(aes(y = n, x = ANO, color = EXAME_), data = exam)
ge <- ge + geom_bar(stat="identity") + facet_grid(EXAME_ ~ .)
ge #Tem muitos NAs nessa- se usar teria que ser somente a partir de 2012 eu acho.

# exame e lamina
ge <- ggplot(aes(y = n, x = TIPO_LAM, group = EXAME_, color = EXAME_), data = exam)
ge <- ge + geom_bar(stat = "identity") + facet_grid(EXAME_ ~ .)
ge

#exame, lamina por ano
ge <- ggplot(aes(y = n, x = ANO, color = TIPO_LAM), data = exam)
ge <- ge + geom_bar(stat = "identity") + facet_grid(EXAME_ ~ .) 
ge
```

- LVC
```{r}
lvc <- df %>%
    group_by(ANO, TIPO_LAM) %>%
    count(ID_LVC_) %>%
    mutate(ID_LVC1 = factor(ID_LVC_, c(1:2), c("LVC", "NOT.LVC")),
           TIPO_LAM1 = factor(TIPO_LAM, c(1:3), c("PCD", "ACD", "LVC") )
           ) 

glvc <- ggplot(aes(y = n, x = ANO, color = ID_LVC1), data = lvc)
glvc <- glvc + geom_bar(stat = "identity") + facet_grid(ID_LVC1 ~ .)
glvc #não sei se está certo esse gráfico

glvc <- ggplot(aes(y = n, x = TIPO_LAM1, group = ID_LVC1, color = ID_LVC1), data = lvc) 
glvc <- glvc + geom_bar(stat = "identity") + facet_grid(ID_LVC1 ~ .)
glvc # há uma grande problema na consistência dessas variáveis. Quando ID_LVC_ é "1", em TIPO_LAM ela aparece relativiamente bastante como sendo busca ativa ou passiva ao contrário de estar como 3, que seria LVC. Quando ID_LVC_ é 2, ela também aparece em TIPO_LAM como LVC.

glvc <- ggplot(aes(y = n, x = ANO, group = TIPO_LAM1, color = TIPO_LAM1), data = lvc) 
glvc <- glvc + geom_bar(stat = "identity", position = "dodge") + facet_grid(ID_LVC1~ .) + xlab("Year") + ylab("Freq.")
glvc  # seria importante tentar descobrir como é de fato feito o preenchimento dessas variáveis. Há muita insconsistência.


```

- Parasitemia: QTD_PARA and QTD_CRUZ   
**QTD_PARA**: It reports the number of parasites per mm3.

*Note*: Fill with the number of parasites per mm3 found on the slide. Leave blank if the test was performed with rapid test.

**QTD_CRUZ**: It reports the amount of parasitemia in crosses, according to the following table.
Parasitemia in Cruzes  
1 - "< +/2"   
2 - "+/2"  
3 - "+"   
4 - "++"   
5 - "+++"  
6 - "++++"    

*Note*: Leave blank only if the previous field (parasites per mm³) has already been filled or if a rapid test was used.

** EXAME **: Inform the type of examination carried out according to the table below.
1 = Thick smear
2 = Rapid test

```{r}
df %>% filter(RES_EXAM=="4") %>% mutate (parac = QTD_PARA>0) %>% add_count(parac, EXAME_ ) %>% distinct(RES_EXAM, parac, EXAME_, n)
df %>% filter(RES_EXAM=="4") %>% mutate (parac = is.na(QTD_PARA)) %>% add_count(parac, EXAME_ ) %>% distinct(RES_EXAM, parac, EXAME_, n)


# Quando QTD_PARA é NA e QTD_CRUZ também: 11145 registros- conferir se entendi certo
df %>% filter(RES_EXAM=="4") %>% mutate (parac = is.na(QTD_PARA)) %>% add_count(parac, QTD_CRUZ) %>% distinct(RES_EXAM, parac, QTD_CRUZ, n)

#Teste rápido e QTD_CRUZ preenchido: 4537 registros
df %>% filter(RES_EXAM=="4") %>% mutate (parac = is.na(QTD_CRUZ)) %>% add_count(parac, EXAME_ ) %>% distinct(RES_EXAM, parac, EXAME_, n)


#QTD_PARA por ano
qtd <- df %>%
    filter(RES_EXAM=="4") %>%
    group_by(ANO, EXAME_) %>%
    count(QTD_PARA)
    
gqtd <- ggplot(aes(y = n, x = ANO), data = qtd)
gqtd <- gqtd + geom_bar(stat = "identity") + facet_grid(EXAME_ ~ .)
gqtd


#QTD_CRUZ por ano
qtd <- df %>%
    filter(RES_EXAM=="4") %>%
    group_by(ANO, EXAME_) %>%
    count(QTD_CRUZ)

gqtd <- ggplot(aes(y = n, x = ANO, color = QTD_CRUZ), data = qtd)
gqtd <- gqtd + geom_bar(stat = "identity", position = "dodge") + facet_grid(EXAME_ ~ .)
gqtd


```


### Contrasting treatment-related variables

**ESQUEMA**  


**ESQUEMA_1** (Campo com códigos no modelo da antiga ficha de notificação): Informa o esquema de tratamento utilizado.  
1-Infecções por Pv com Cloroquina em 3 dias e Primaquina 7 dias  
2-Infecções por Pf com Quinina em 3 dias + Doxiciclina em 5 dias + Primaquina no 6o dia  
3-Infecções Mistas por Pv + Pf com Mefloquina em dose única e Primaquina em 7 dias  
4-Infecções por Pm com Cloroquina em 3 dias  
5-Infecções por Pv em crianças apresentando vômitos, com cápsulas retais de Artesunato em 4 dias e Primaquina em 7 dias  
6-Infecções por Pf com Mefloquina em dose única e Primaquina no segundo dia  
7-Infecções por Pf com Quinina em 7 dia  
8-Infecções por Pf de crianças com cápsulas retais de artesunato em 4 dias e dose única de Mefloquina no 3o dia e Primaquina no 5o dia   
9-Infecções mistas por Pv + Pf com Quinina em 3 dias, Doxiciclina em 5 dias e Primaquina em 7 dias  
10-Prevenção de recaída da Malária por Pv com Cloroquina em dose única semanal durante 3 meses  
11-Malária grave e complicada  
99-Outro Esquema utilizado (por médico)  
```{r}


```


